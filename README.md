# Bodylight.js FMU Compiler
[![stability-beta](https://img.shields.io/badge/stability-beta-33bbff.svg)](https://github.com/mkenney/software-guides/blob/master/STABILITY-BADGES.md#beta)

This repository contains scripts and configuration facilitating compilation of FMU file (with source codes in C of compiled Modelica model and solver) to Javascript with embedded WebAssembly. 
Such compiled javascript allows to access model simulation via FMI API v 2.0 as specified in FMI standard.

* FMU co-simulation mode with source codes and CVODE solver generated by Dymola is fully supported.
* FMU co-simulation mode with source codes and CVODE solver generated by OpenModelica is supported.

This repository also contains basic HTML and Python script as CGI script to support compilation as web service on Linux platform with (EMSDK, GlibC,...).

To use Bodylight.js-FMU-Compiler, choose one of these options:
1. compiler in docker - needs docker to be installed in environment.
2. compiler in virtual machine - Vagrant tool and VirtualBox is needed - see [Bodylight-Virtualmachine](https://github.com/creative-connections/Bodylight-VirtualMachine)
3. compiler in local environment - needs to install EMSDK,GLIBC and PYTHON3 manually

You may follow our tutorial at https://bodylight.physiome.cz/Bodylight-docs/tutorial/

## 1. Manual compiler (default, updated 12/2025)
```bash
git clone https://github.com/creative-connections/Bodylight.js-FMU-Compiler
cd Bodylight.js-FMU-Compiler
cd manual_compiler
```
For Modelica models in OpenModelica:
1. you need `docker` in your environment, 
2. in OMEdit, export model as FMU 2.0 in co-simulation with CVODE solver, with source code and with `--fmiFlags=s:cvode` set in Tools->Options->Simulation->Additional Translation flags
3. with the resulting `my_model.fmu` launch script
```bash
./om_compile_docker.sh [-o] my_model.fmu
```

For Modelica models in Dymola.
1. you need `docker` in your environment, 
2. in Dymola export model as FMU 2.0 in co-simulation with source code and CVODE solver
3. with the resulting `my_model.fmu` launch script
```bash
./dy_compile_docker.sh [-o] my_model.fmu
```

Use option `-o` to enable compilation optimization, producing smaller and faster code (using `-O3 --clossure 1`), by default it is disabled.

The script compiles FMU to 'JS' binary and puts it into FMU/binaries/wasm32/ and creates also ZIP file with JS and XML with model description. Use it with bodylight.js web components.

## 2. Compiler in Virtual Machine with upload/compiler web service (deprecated)
(Recommended)
Install Bodylight-VirtualMachine using `vagrant` tool and VirtualBox. Instruction at https://github.com/creative-connections/Bodylight-VirtualMachine 
The compiler web service is available at http://localhost:8080/compiler

## 3. Compiler in Local Environmnet with upload/compiler web service (deprecated)
(on your own risk)
Be sure that EMSDK, GLIBC 2.18, Python 3 and CMake are installed e.g.
- https://github.com/emscripten-core/emsdk.git
- https://ftp.gnu.org/gnu/glibc/glibc-2.18.tar.gz
- Python3 - use your system installer: e.g. `yum install python3` or `apt install python3` or install Miniconda or Anaconda environment (https://www.anaconda.com/products/individual)
- CMake - use your system installer: e.g. `yum install cmake` or `apt install cmake`

Bodylight.js-FMU-Compiler contains `index.html` and `save-file.py` to support compilation via simple web interface. Make the root of Bodylight.js-FMU-Compiler accessible for Apache web server, and the simple web form can be used.
E.g.
```
Alias "/compiler" "/home/vagrant/Bodylight.js-FMU-Compiler/"
<Directory "/home/vagrant/Bodylight.js-FMU-Compiler">
  Options +ExecCGI
  AddHandler cgi-script .py
  Header set Access-Control-Allow-Origin "*"
  Require all granted
  Options +Indexes +FollowSymLinks +IncludesNOEXEC
  IndexOptions FancyIndexing HTMLTable NameWidth=*
  AllowOverride All
</Directory> 
```

Allow access to input and output subdirectories of `Bodylight.js-FMU-Compiler`.
```
chmod ugo+rwx input output
```

# Examples

The following models were converted to web-based simulators using FMU compiler.
* [Hemodynamics](https://egolem.online/demo/#hemo2.md) - model of hemodynamics of cardiovascular system with simulated volume,presure during cardiac cycle
* [Simple Circulation](http://www.physiome.cz/en/simple-circulation/) - model published as part of Physiolibrary
  * Kulhánek T, Tribula M, Kofránek J, Mateják M: Simple models of the cardiovascular system for educational and research purposes. MEFANET Journal 2014; 2(2); ISSN:1805-9171. Available at WWW: http://mj.mefanet.cz/mj-04140914.
* [Nefron Simulation](http://www.physiome.cz/apps/Nephron/) - model and Bodylight.js technology published as 
  * ŠILAR, Jan, David POLÁK, Arnošt MLÁDEK, Filip JEŽEK, Theodore W KURTZ, Stephen E DICARLO, Jan ŽIVNÝ a Jiri KOFRANEK. Development of In-Browser Simulators for Medical Education: Introduction of a Novel Software Toolchain. Journal of Medical Internet Research [online]. 2019, 21(7) [cit. 2019-11-25]. DOI: 10.2196/14160. ISSN 1438-8871. Dostupné z: https://www.jmir.org/2019/7/e14160
* [Bodlight Scenarios](https://bodylight.physiome.cz/Bodylight-Scenarios) - simulators using web components. Section of hemodynamics, blood-gases, iron metabolism and virtual body preparing for publication
* [Buddy](http://physiome.cz/buddy/) - experimental simulator of most complex model of physiology [Physiomodel](https://www.physiomodel.org) 

The simple and medium size models compile into Javascript with size 0.5 MB - 2 MB. The embedded [WebAssembly](https://webassembly.org/) is supported by 4 major web browsers (Firefox,Chrome,Ms Edge,Safari). The simulation is nearly native speed (1.5x or 2x slower). One drawback can be memory limit on some mobile devices, which may prevent to run some of the most complex model (see Buddy above) there.
